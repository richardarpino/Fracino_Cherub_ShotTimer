# Fracino Cherub Shot Timer & Boiler Monitor

![Compile and Test Native](https://github.com/richardarpino/Fracino_Cherub_ShotTimer/actions/workflows/compile.yml/badge.svg)

Custom ESP32 firmware for the Fracino Cherub espresso machine, providing real-time boiler diagnostics and an automated shot timer using a modular "Pull Model" architecture.

For detailed developer notes, methods, and tool documentation, visit the [Project Wiki](https://github.com/richardarpino/Fracino_Cherub_ShotTimer/wiki).

## ðŸš€ Quick Start
1. **Hardware**: Connect your sensor and signals according to the mappings in `include/pins.h`.
2. **Configuration**: 
    - Copy `include/secrets.h.example` to `include/secrets.h` and add your WiFi credentials.
    - Copy `include/pins.h.example` to `include/pins.h` and verify the pin mappings for your board.
3. **Build & Test**: 
    - Build: `pio run -e lilygo-t-display`
    - Test: `pio test -e native` (Run logic tests instantly on your PC)

## ðŸ— Modular Architecture
The project uses a **Pull Model** to decouple data sources from the UI.

### ðŸ“¡ Sensors (`lib/Interfaces`, `lib/BoilerPressure`, `lib/ShotTimer`)
Everything providing data implements `ISensor`.
- `BoilerPressure`: Raw ADC -> Bar (Inherits from `FilteredSensor`).
- `BoilerTemperature`: Bar -> Celsius (Antoine Equation).
- `ShotTimer`: GPIO -> Seconds (Timing State Machine with debounce).

### ðŸ›¡ï¸ Sensor Stability & Smoothing
To handle noisy ADC signals (especially on ESP32), we use a two-tiered approach:
1. **Hardware Oversampling**: `ADCRawSource` averages 64 consecutive ADC samples to floor electronic noise.
2. **`FilteredSensor` Base Class**: Provides centralized **EMA Smoothing** and **Display Hysteresis**. Hysteresis prevents "jitter" at decimal boundaries by requiring a minimum change (e.g., 0.02 Bar) before updating the UI.

### ðŸŽ¨ UI & Widgets (`lib/UI`)
Widgets implement `IWidget` and pull data from sensors independently.
- **Late-Parenting**: Widgets are created without parents and "adopted" by the layout manager.
- **SRP Decoupling**: Widgets only manage their internal content; the layout manages all positioning.

## ðŸ›  Developer Guide

### 1. Unit Testing
Logic-heavy components are tested in a `native` environment.
```bash
pio test -e native
```
Stubs for `Arduino.h` and `String` are provided in `test/stubs` to allow for rapid desktop-based verification.

### 2. Registering Widgets
The UI layout is managed automatically in `main.cpp`. Widgets are added in the order: **Top-Left (0), Bottom-Left (1), Top-Right (2), Bottom-Right (3)**.

```cpp
ScreenLayout* layout = shotDisplay.getLayout();
layout->addWidget(new SensorWidget(&boilerPressure));   // Slot 0
layout->addWidget(new SensorWidget(&boilerTemp));       // Slot 1
layout->addWidget(new StatusWidget(&shotTimer));        // Slot 2
layout->addWidget(new SensorWidget(&shotTimer, true));  // Slot 3
```

### 3. Adding a Filtered Sensor
Inherit from `FilteredSensor` to get automatic smoothing:
```cpp
class MySensor : public FilteredSensor {
    MySensor() : FilteredSensor(0.1f, 0.05f) {} // alpha, hysteresis
    Reading getReading() override {
        updateFilter(newValue);
        return Reading(getStableDisplayValue(), "UNIT", "LABEL");
    }
};
```

## ðŸ”Œ Hardware Pins

Example board used for development: [TENSTAR T-Display ESP32 Development Board with 1.14 Inch LCD](https://www.aliexpress.com/item/1005062610762446.html). PlatformIO environment: `lilygo-t-display` is compatible.

| Pin | Function | Hardware Required |
| :--- | :--- | :--- |
| **GPIO 32** | Pressure Sensor | 10kÎ© + 10kÎ© Voltage Divider |
| **GPIO 25** | Pump Signal | AC Optocoupler Isolation |
| **GPIO 35** | Theme Button | Built-in (Right button) |
| **GPIO 4** | LCD Backlight | Built-in |

---
*Generated by [Antigravity](https://deepmind.google/)*
